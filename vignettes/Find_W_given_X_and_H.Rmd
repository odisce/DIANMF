---
title: "Find W, given X and H"
author: "Diana Karaki"
date: "`r Sys.Date()`"
package: "`r pkg_ver('DIANMF')`"

vignette: >
  %\VignetteIndexEntry{Find W, given X and H}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: '`r system.file("bib", "references-vignette.bib", package = "DIANMF")`'
output: 
  BiocStyle::html_document:
    citation_package: natbib
    csl: nature.csl
    fig_caption: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
    editor_options: 
      markdown: 
       wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```


# Introduction
This vignette demonstrates how to extract pure spectra $W$ given a matrix of mixed compounds $X$ and their respective pure elution profiles $H$. This method can be applied to both data levels, MS1 and MS2. Here, we will apply it to MS2 data.

First, we load our package and the test file used in the previous vignettes and process all detected MS1 peaks.

```{r setup}
# load package
library(DIANMF)

# load the data-set
file <- system.file("extdata", "test_data.mzml", package = "DIANMF")
```

```{r main function MS2 level, echo=TRUE }
MS2_features <- dia_nmf.f( mzML_path = file,
                           ms_level = "MS2",
                           peaks_by_xcms = TRUE, ms1_peaks = NULL, d.out = NULL,
                           ppm = 6, peakwidth = c(3,60), snthresh = 0,
                           prefilter = c(5,4000), mzCenterFun = "wMeanApex3",
                           integrate = 2, mzdiff = -0.001, noise = 0,
                           firstBaselineCheck = FALSE)
```

# Find W
For the first peak, let us extract its raw matrix $X$ and elution profiles matrix $H$ from the MS2_features object.

```{r extract X and H, echo=TRUE }
peak.idx <- 1

# extract X
MS2_raw_matrices <- extract_mixedMat(features = MS2_features, ms_level = 'MS2')
X <- MS2_raw_matrices[[peak.idx]]

# extract H
H_ms2.l <- extract_pureMat(features = MS2_features, ms_level = 'MS2', H = TRUE)
H <- H_ms2.l[[peak.idx]]
# knitr::kable(head(H_ms2))
```

<span style="background-color: rgba(169, 169, 169, 0.4);">find_W()</span> is a function from **DIANMF**, that aims to find $W$ from $X$ and $H$. This function is based on the forward-backward algorithm (FBS) and more specifically on the positive-projection algorithm [@Combettes_2005_SignalRecoveryProximal]. It iterates to find the best $W$, where every column of $W$ is a pure spectrum related to a compound in $X$, [see find W](#caseW). 

The function parameters:

* <span style="background-color: rgba(169, 169, 169, 0.4);">X</span> matrix contains components' sources mixed up in an unknown but linear way. Every row is an elution profile from the candidate precursor and its fragment ions through the rt scans in the columns.
* <span style="background-color: rgba(169, 169, 169, 0.4);">H</span>
* <span style="background-color: rgba(169, 169, 169, 0.4);">maxFBIteration</span> max number of iterations
* <span style="background-color: rgba(169, 169, 169, 0.4);">toleranceFB</span> tolerance or stopping value of the FB algorithm.

```{r find A, echo=TRUE}
W <- find_W(X = X, H = H, maxFBIteration = 20, toleranceFB = 1e-5)
# knitr::kable(W, row.names = FALSE)

# plot the mixed spectrum (from X) vs W
mz_peak <- MS2_features[[1]]$peak$mz
  
p <- plot_MS_spectra(ms_mixed = X, ms_pure_W = W, ms_level = "MS2", mz_prec = mz_peak, choosen_comp = "")
p
```

# Appendix 

## Algorithm FISTA for the sub-problem in W {#caseW}
<hr style="border: 1px solid black;">

1.  **Start:** Updates$(X, H, \lambda, W_{0})$
1.  **initialize** $R_{0}=W_{0},  L=||HH^{T}||_{s},  t_1=1,  k=1$
1.  **while** not convergence **do**
1.  $W_{k+1} = [Soft_{\frac{\lambda}{L}}(R_{k} - \frac{1}{L} (R_{k}H - X) H^T )]_+$
1.  $t_{k+1} = \frac{1 + \sqrt{1+4t^2_k}}{2}$
1.  $R_{k+1} = W_{k+1} + \frac{t_k - 1 }{t_{k+1}} (W_{k+1} - W_k)$
1.  $k = k + 1$
1.  **end while**
1.  **return** $W_{k+1}$

<hr style="border: 1px solid black;">



# Session info
Here is the output of `sessionInfo()` on the system on which this document was compiled:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References

