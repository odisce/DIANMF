---
title: "Extract MS2 Pure Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extract MS2 Pure Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

## Introduction
This vignette concerns the MS2 level data; it describes how to process LC-MS/MS mzML files to identify metabolites by giving their pure MS2 spectra that characterize them. As described in the 'Process MS1 data level' vignette, we will use the same mzML file containing SWATH DIA processed data.

Before we go on, we will attach the packages we use, expose the version of DIANMF.

```{r setup}
library(DIANMF)

packageVersion("DIANMF")
```

## Data import
```{r load mzML file, echo=TRUE }
file <- system.file("extdata", "test_data.mzml", package = "DIANMF")
load("~/DIA_NMF_R_package/dianmf/data/data_example.rda")
```

## Extract MS2 features 
To extract MS2 features from LC-MS/MS data, the MS1 pure spectrum for each identified metabolite in the raw mzML file are obtained first in our approach. The pure MS1 data will be used to extract the pure MS2 data. As before, the user can provide the MS1 peaks or detect them by [xcms](https://bioconductor.org/packages/release/bioc/html/xcms.html) algorithm.

We use the <span style="background-color: rgba(169, 169, 169, 0.4);">dia_nmf.f()</span> function with <span style="background-color: rgba(169, 169, 169, 0.4);">ms_level = "MS2"</span>.

```{r main function MS2 level, echo=TRUE }
MS2_features <- dia_nmf.f( mzML_path = file,
                          ms_level = "MS2",
                          peaks_by_xcms = TRUE, ms1_peaks = NULL, d.out = NULL,
                          ppm = 6, peakwidth = c(3,60), snthresh = 0,
                          prefilter = c(5,4000), mzCenterFun = "wMeanApex3",
                          integrate = 2, mzdiff = -0.001, noise = 0,
                          firstBaselineCheck = FALSE)
```

The MS2_features object contains both the raw and pure MS1 and MS2 information for every identified metabolite.

We are getting this note for some peaks as 1,5,16: No specific MS2 fragments. This means the peak mz is out of the SWATH isolation windows mz ranges, so it was not fragmented in the MS2 level.

```{r MS1 pure spectra, echo=TRUE }
MS1_pure_spectra <- extract_pureSpect( features = MS2_features, spec_level = 'MS1' )
MS2_pure_spectra <- extract_pureSpect( features = MS2_features, spec_level = 'MS2' )
```

## Process one specific peak

Again, to familiarize ourselves with the different functions in the "DIANMF" package regarding processing the MS2 data, we will process one specific peak from the peak list detected in this file.

### Detect and prepare MS1 peaks
```{r detect MS1 peaks using xcms, echo=TRUE, message=FALSE, warning=FALSE}
ms1_peaks.mat <- detect_peaks_by_xcms(rawData.onDiskMSnExp = data_example,
                                        ppm = 6, peakwidth = c(3,60), snthresh = 0,
                                        prefilter = c(5,4000), mzCenterFun = "wMeanApex3",
                                        integrate = 2, mzdiff = -0.001, noise = 0,
                                        firstBaselineCheck = FALSE )
  
ms1_peaks.df <- prepare_ms1_peaks(ms1_peaks = ms1_peaks.mat)
```

#### Choose the MS1 peak
```{r choose MS1 peak, echo=TRUE }
peak.idx <- 3
mz_prec <- ms1_peaks.df[peak.idx, 'mz']
rt_prec <- ms1_peaks.df[peak.idx, 'rt']
```

### Process the MS1 level of this peak
```{r process MS1 level, echo=TRUE }
peak_ms1_feature <- dia_nmf.f( mzML_path = file, 
                               ms_level = "MS1",
                               peaks_by_xcms = FALSE, ms1_peaks = ms1_peaks.df[peak.idx, ])
```

```{r extract the peak MS1 pure spectrum, echo=TRUE }
H_ms1 <- extract_pureMat(features = peak_ms1_feature, ms_level = "MS1", H = TRUE)
# knitr::kable(H_ms1[, c(1:9)])

W_ms1 <- extract_pureMat(features = peak_ms1_feature, ms_level = "MS1", H = FALSE)

ms1_pure_data <- extract_ms1_pure_spectrum(W_ms1 = W_ms1, mz_prec = mz_prec)
peak_ms1_spectrum <- ms1_pure_data$ms1_pure_spectrum

# or

peak_ms1_spectrum <- MS1_pure_spectra[[peak.idx]]
# knitr::kable(head(peak_ms1_spectrum))
```

### Extract the MS2 mixed matrix

We are working with SWATH DIA data file. Such data has essential information called the isolation window ranges. This information can be extracted using <span style="background-color: rgba(169, 169, 169, 0.4);">isolationWindows.range()</span> function from **DIANMF**. This method needs the `r class(data_example)` raw data from the mzML file.

```{r SWATH isolation windows, echo=TRUE }
info.swath <- isolationWindows.range(data_example)
# knitr::kable(info.swath)
```

Our strategy extracts the MS2 data from every isolation window related to this peak `r peak.idx`. Furthermore, the MS1 pure spectrum fragments are essential in finding these MS2 data. <span style="background-color: rgba(169, 169, 169, 0.4);">extract_ms2_matrices()</span> function extract the MS2 matrices from every isolation window <span style="background-color: rgba(169, 169, 169, 0.4);">info.swath</span> using for sure the peak <span style="background-color: rgba(169, 169, 169, 0.4);">ms1_pure_spectrum</span>, the peak index <span style="background-color: rgba(169, 169, 169, 0.4);">peak.idx</span> and some other parameters.

```{r extract the mixed MS2 data as matrix, echo=TRUE }
res_ms2 <- extract_ms2_matrices(peak.idx = peak.idx, ms1_peaks.df = ms1_peaks.df,
                                ppm.n = 7, ms1_pure_spectrum = peak_ms1_spectrum,
                                rawData.onDiskMSnExp = data_example, info.swath = info.swath )
ms2_matrix <- do.call(rbind, res_ms2)
```

<span style="background-color: rgba(169, 169, 169, 0.4);">nGMCAs()</span> function is used to factorize the mixed MS2 data.

```{r NMF MS2 data, echo=TRUE }
ms2_rank <- 3
ngmcas_res <- nGMCAs(X.m = ms2_matrix, rank = ms2_rank,
                     maximumIteration = 10, maxFBIteration = 10, toleranceFB = 1e-5,
                     initialization_method = 'subSample', H_sub = H_ms1)

W_ms2 <- ngmcas_res$S
H_ms2 <- ngmcas_res$A
```

W_ms2 and H_ms2 are of class `r class(W_ms2)`, representing the MS2 representing the elution profiles (chromatograms) and pure spectra, respectively.

Finally, we can extract the pure MS2 spectra related to the peak. This spectrum contains MS2 fragments of the precursor, the precursor losses, adducts, and their isotopes.
We need to know first which MS2 spectrum from W_ms2 corresponds to the peak. To specify this information, we will calculate the correlation between the peak MS1 corresponding elution profile and the MS2 elution profiles using the function <span style="background-color: rgba(169, 169, 169, 0.4);">elutions_corelation()</span>. Then use <span style="background-color: rgba(169, 169, 169, 0.4);">choose_ms2_pure_spectrum()</span> to extract the choosen MS2 spectrum.

```{r choose the good MS2 spectrum, echo=TRUE }
comp_ms1 <- ms1_pure_data$comp_ms1
comp_ms2 <- elutions_corelation(chromo_main = H_ms1[comp_ms1, ], chromos = H_ms2)
ms2_pure_spectrum <- choose_ms2_pure_spectrum(W_ms2 = W_ms2, choosen_comp = comp_ms2)
```

To extract just the MS2 fragments related to the precursor and its fragments, we add in the *DIANMF* the <span style="background-color: rgba(169, 169, 169, 0.4);">filter_ms2_spectrum()</span> function. It needs the <span style="background-color: rgba(169, 169, 169, 0.4);">ms2_matrices</span>,  <span style="background-color: rgba(169, 169, 169, 0.4);">mz_prec</span>, and  <span style="background-color: rgba(169, 169, 169, 0.4);">info.swath</span> to determine in which isolation window this precursor belongs then extract the specific fragments from <span style="background-color: rgba(169, 169, 169, 0.4);">ms2_pure_spectrum</span>.

```{r choose the specific MS2 spectrum, echo=TRUE }
ms2_pure_spectrum_specific <- filter_ms2_spectrum(ms2_pure_spectrum = ms2_pure_spectrum, ms2_matrices = res_ms2, mz_prec = mz_prec, info.swath = info.swath)
knitr::kable(head(ms2_pure_spectrum_specific))
```

#### plot mixed and pure MS2 data

```{r plot data, echo=TRUE, fig.height=6, fig.width=7.2}

p_eics <- plot_MS_eics(ms_mixed = ms2_matrix, ms_pure_H = H_ms2, ms_level = "MS2", rt_prec = rt_prec, choosen_comp = comp_ms2)
p_eics

p_spectra <- plot_MS_spectra(ms_mixed = ms2_matrix, ms_pure_W = W_ms2, ms_level = "MS2", mz_prec, choosen_comp = comp_ms2)
p_spectra
```

## Match the pure MS2 spectrum
soon....


